# 13. Поведение данных при редактировании дела и записи

При изменении дела (название, описание, блоки) важно зафиксировать, что происходит с уже существующими записями и с отображением в приложении. Ниже также описаны правила создания и редактирования **записи** и привязки конфигов блоков к ответам. Схема версий конфигов: [04-block-config-schema.md](../technical/04-block-config-schema.md).

---

## Создание записи (новая запись)

- Форма заполнения (FillForm) строится по **текущему** конфигу дела: список блоков и для каждого блока — текущие опции/шкала из `blocks.config`.
- При сохранении для каждого ответа (scale, single_select, multi_select) система находит или создаёт версию конфига в таблицах истории (`block_config_versions`, `block_config_scale_versions`, `block_config_select_option_versions`) по текущему `blocks.config` и записывает `config_version_id` в `record_answers`.
- Для блоков без конфига (number, text_short, text_paragraph, yes_no, duration) в `record_answers` сохраняется `config_version_id = NULL`.

---

## Редактирование записи

- Форма редактирования записи строится по **текущему** конфигу дела: показываются только неудалённые блоки (`deleted_at` пустой), в том же порядке и с теми же опциями/шкалами, что и в форме создания новой записи.
- Редактирование записи приравнивается к пересохранению ответов в актуальном конфиге: пользователь мог намеренно изменить блоки дела, и при редактировании записи мы используем именно текущее состояние дела.
- При сохранении (api.records.update) для каждого переданного ответа берётся **текущий** блок дела, по нему находится или создаётся версия конфига (`findOrCreateConfigVersion(block)`), и в `record_answers` обновляются `value_json` и `config_version_id`. То есть запись после сохранения привязывается к актуальной версии конфига дела (как при создании новой записи).
- В форме редактирования отображаются только неудалённые блоки, поэтому в `payload.answers` при сохранении попадают только ответы по ним. Ответы по удалённым блокам в БД не изменяются (они остаются в записи и отображаются в секции «Удалённые блоки» при просмотре).

---

## Просмотр записи и устаревшие ответы

- При просмотре записи ответы отображаются с учётом сохранённого конфига: для каждого ответа конфиг берётся из версии по `record_answers.config_version_id` (таблицы истории).
- **Устаревший ответ:** если у ответа есть `config_version_id` и конфиг этой версии не совпадает с текущим `blocks.config`, либо если блок удалён (`deleted_at` не пустой). Такие ответы показываются в блоке «Устаревшее» с названием блока, сохранённым значением и конфигом на момент ответа; пользователю предлагается **«Актуализировать»** — перевыбрать значение в текущих опциях/шкале (после актуализации ответ перепривязывается к новой версии конфига).

---

## Изменение названия дела

- Название дела хранится в самой сущности «дело», а не в каждой записи.
- **Записи** остаются привязаны к тому же делу; связь не меняется.
- В интерфейсе (список дел, история записей, заголовки) везде показывается **текущее** название дела. То есть после переименования все экраны отображают новое название, в том числе при просмотре старых записей — контекст задаётся актуальным названием дела.

## Изменение описания дела

- Описание хранится в деле. Записи не хранят копию описания.
- При просмотре формы или контекста дела показывается текущее описание. На старые записи это не влияет.

## Удаление блока

- Блок исчезает из формы: при создании новых записей и при редактировании записи он больше не отображается (в форме редактирования записи выводятся только неудалённые блоки).
- **В существующих записях** данные по удалённому блоку не теряются: ответ хранится в `record_answers`, конфиг — в версии по `config_version_id`. При просмотре записи дело загружается с учётом удалённых блоков (`includeDeletedBlocks`), и удалённые блоки показываются в секции «Удалённые блоки» с названием блока, сохранённым значением и конфигом на момент ответа. См. [02-entity-deed.md](02-entity-deed.md) и [04-block-config-schema.md](../technical/04-block-config-schema.md).

## Добавление блока

- Новый блок появляется в форме и участвует во всех **новых** записях.
- В **старых** записях (созданных до добавления блока) для этого блока значения нет: при просмотре такой записи новый блок отображается пустым (прочерк, «Не заполнено» или поле без значения). Это нормально: запись отражает состояние формы на момент заполнения.

## Переименование блока

Пользователь меняет только текст вопроса (заголовок блока), тип и параметры блока не трогает.

- Заголовок блока хранится в деле. Записи хранят ответ по блоку (по идентификатору блока), а не копию заголовка.
- После переименования при просмотре любой записи (и старой, и новой) отображается **текущее** название блока. То есть везде показывается актуальный заголовок — запись не «замораживает» старый текст вопроса. Если в будущем понадобится показывать «как назывался вопрос на момент ответа», это потребует хранить снимок заголовка в записи (отдельное решение).

## Изменение типа блока

Пользователь может переключить существующий блок с одного типа на другой (например, с «Число» на «Текст (строка)» или с «Один из списка» на «Шкала»). Блок и его название сохраняются; меняется только тип ввода и способ отображения ответа.

- **В старых записях:** блок остаётся, ответ хранится. Сохранённое значение было введено в старом формате — оно считается устаревшим (конфиг версии не совпадает с текущим типом/конфигом блока). При просмотре система показывает значение в блоке «Устаревшее» и предлагает **«Актуализировать»**: пользователь может ввести/выбрать значение в новом формате (после сохранения ответ перепривязывается к новой версии конфига) или оставить как есть.

## Изменение списка вариантов (блоки «Один из списка» и «Несколько из списка»)

Пользователь редактирует варианты ответа в списке: добавляет, правит текст или удаляет вариант.

- **Редактирование значения (переименование варианта).**  
  Вариант — это поле в настройках блока (option_id и label в конфиге). При изменении текста варианта в текущем конфиге дела отображается новое название. В старых записях ответ привязан к версии конфига: если подпись варианта в версии отличается от текущей, ответ считается устаревшим и при просмотре показывается с подписью из версии (старое название) и предложением актуализировать. Связь по идентификатору варианта (option_id) сохраняется.

- **Добавление значения.**  
  В список добавляется новый вариант. Он доступен при заполнении новых записей. На старые записи не влияет — в них по-прежнему только те варианты, которые были на момент ответа.

- **Удаление значения из списка.**  
  Вариант убирается из настроек блока и больше не предлагается при новом заполнении. В **старых записях** ответ сохраняется; при просмотре конфиг берётся из версии по `config_version_id`. Если конфиг версии не совпадает с текущим `blocks.config`, ответ считается устаревшим и показывается в блоке «Устаревшее» с предложением **«Актуализировать»**: пользователь может выбрать значение из текущего списка (после сохранения ответ перепривязывается к новой версии конфига).

## Изменение параметров блока без смены типа

Пользователь не меняет тип блока, но меняет его настройки. Пример: в блоке «Шкала» уменьшили количество делений (было 10, стало 5) или поменяли подписи делений.

- В **старых записях** сохранённое значение остаётся в `record_answers`; конфиг на момент ответа хранится в версии по `config_version_id`. При просмотре, если конфиг версии не совпадает с текущим `blocks.config`, ответ считается устаревшим и показывается в блоке «Устаревшее» с предложением **«Актуализировать»**: пользователь может выбрать значение по текущим параметрам блока (например, на обновлённой шкале); после сохранения ответ перепривязывается к новой версии конфига.
