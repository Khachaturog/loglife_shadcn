# Подробная инструкция по настройке Supabase для Log Life

В проекте Supabase используется как бэкенд: база данных (Postgres), аутентификация пользователей и API с фронтенда через клиентскую библиотеку. Отдельного сервера (Node.js и т.п.) нет.

---

## 1. Что понадобится

- Аккаунт на [supabase.com](https://supabase.com) (бесплатный тариф подойдёт для разработки).
- Локально: скопировать файл миграции из репозитория и создать файл `.env` в корне проекта.

---

## 2. Создание проекта в Supabase

1. Зайдите на [app.supabase.com](https://app.supabase.com) и войдите в аккаунт.
2. Нажмите **New project**.
3. Заполните:
   - **Name** — например, `log-life` или `log-life-dev`.
   - **Database Password** — придумайте надёжный пароль и **обязательно сохраните его** (для доступа к БД через CLI или внешние клиенты; для самого приложения он не нужен).
   - **Region** — выберите ближайший регион.
4. Нажмите **Create new project** и дождитесь создания (обычно 1–2 минуты).

---

## 3. Где взять URL и anon key

Эти значения нужны фронтенду для подключения к вашему проекту.

1. В левом меню Supabase откройте **Project Settings** (иконка шестерёнки внизу).
2. Перейдите в раздел **API**.
3. Скопируйте:
   - **Project URL** — например, `https://xxxxxxxx.supabase.co`.
   - **anon public** key (в блоке "Project API keys") — длинная строка, начинается с `eyJ...`.  
     Используйте именно **anon**, а не **service_role** (service_role обходит RLS и не должен быть на фронте).

---

## 4. Создание таблиц и RLS (миграция)

В репозитории уже есть готовая миграция: `supabase/migrations/20250212000000_initial_schema.sql`.

### Вариант A: через веб-интерфейс (SQL Editor)

1. В левом меню Supabase откройте **SQL Editor**.
2. Нажмите **New query**.
3. Откройте файл `supabase/migrations/20250212000000_initial_schema.sql` в редакторе на своём компьютере и **скопируйте весь его текст**.
4. Вставьте скопированный SQL в окно запроса в Supabase.
5. Нажмите **Run** (или Ctrl+Enter).
6. Внизу должно появиться сообщение об успешном выполнении. В левом меню в **Table Editor** появятся таблицы: `deeds`, `blocks`, `records`, `record_answers`.

### Вариант B: через Supabase CLI (опционально)

Если установлен [Supabase CLI](https://supabase.com/docs/guides/cli):

```bash
supabase login
supabase link --project-ref ваш-project-ref
supabase db push
```

`project-ref` можно взять из URL проекта в Dashboard (часть перед `.supabase.co`) или из **Project Settings → General**.

### Что делает миграция

- Создаёт таблицы с правильными типами и связями (в т.ч. `deeds.user_id` → `auth.users.id`).
- Включает **Row Level Security (RLS)** на всех таблицах.
- Создаёт политики: пользователь видит и меняет только свои дела и связанные с ними блоки, записи и ответы. Доступ к чужим данным через API невозможен.

Подробное описание таблиц — в [01-supabase-schema.md](01-supabase-schema.md).

---

## 5. Включение аутентификации (Auth)

Приложение ожидает, что пользователь войдёт через Supabase Auth. Без входа запросы к данным (например, список дел) вернут ошибку, и на экране может отображаться сообщение вроде «Необходима авторизация».

1. В левом меню откройте **Authentication**.
2. Перейдите в **Providers**.
3. **Email** по умолчанию уже включён. Можно оставить только его:
   - Пользователи регистрируются по email и паролю.
   - При желании включите **Confirm email** (тогда после регистрации нужно подтвердить почту по ссылке из письма).
4. При необходимости добавьте другие провайдеры (Google, GitHub и т.д.) в **Providers** и настройте их по [документации Supabase](https://supabase.com/docs/guides/auth).

Страница входа/регистрации в самом приложении Log Life пока реализуется отдельно (в плане — экран «Профиль» и заглушка «Авторизация»). Для проверки можно создать пользователя вручную:

1. **Authentication → Users → Add user**.
2. Укажите email и пароль и при необходимости включите **Auto Confirm User**, чтобы не подтверждать email.

После этого можно войти в приложение, когда на фронте будет добавлена форма входа (через `supabase.auth.signInWithPassword` и т.п.).

---

## 6. Переменные окружения в проекте

Фронтенд читает URL и anon key из переменных окружения Vite.

1. В корне проекта создайте файл `.env` (если его ещё нет).
2. Скопируйте содержимое из `.env.example` и подставьте свои значения:


3. Подставьте реальные **Project URL** и **anon public** key из раздела **API** в настройках проекта Supabase.
4. Сохраните файл. Файл `.env` не коммитится в git (указан в `.gitignore`).
5. Перезапустите dev-сервер (`npm run dev`), чтобы Vite подхватил новые переменные.

---

## 7. Как приложение использует Supabase

- **Клиент** создаётся в `src/lib/supabase.ts` с помощью `createClient(VITE_SUPABASE_URL, VITE_SUPABASE_ANON_KEY)`.
- **Запросы к данным** идут через слой `src/lib/api.ts`: список дел, одно дело с блоками, создание/обновление/удаление дел, блоки, записи и ответы. Везде используется тот же клиент и, при необходимости, текущий пользователь `auth.uid()` (через RLS).
- **Аутентификация**: после добавления экрана входа будут вызываться методы Supabase Auth (`signInWithPassword`, `signUp`, `signOut`, подписка на `onAuthStateChange`). RLS автоматически ограничивает выборки по `user_id` для таблицы `deeds` и связанных таблиц.

Если URL или anon key не заданы, в консоли браузера появится предупреждение, а запросы без авторизации приведут к ошибкам доступа.

---

## 8. Проверка настройки

1. Убедитесь, что миграция выполнена: в **Table Editor** есть таблицы `deeds`, `blocks`, `records`, `record_answers`.
2. Убедитесь, что в **Authentication → Policies** (или в **Table Editor** у каждой таблицы) включён RLS и есть политики для `deeds` и остальных таблиц (они создаются миграцией).
3. В приложении задайте `.env`, запустите `npm run dev`, откройте приложение в браузере. После реализации входа залогиньтесь — список дел должен загружаться (сначала пустой); создание дела должно сохраняться в таблице `deeds` с вашим `user_id`.

---

## 9. Частые проблемы

- **«Необходима авторизация»** — пользователь не залогинен. Нужно реализовать экран входа и вызывать `supabase.auth.signInWithPassword` (или другой метод) и хранить сессию; тогда RLS будет видеть `auth.uid()`.
- **Ошибки при создании дела/записи** — проверьте, что RLS-политики созданы миграцией и что пользователь действительно авторизован (в **Authentication → Users** есть соответствующий пользователь).
- **CORS** — для домена приложения (в т.ч. `localhost`) Supabase по умолчанию уже разрешает запросы. Если разворачиваете на другом домене, при необходимости добавьте его в настройках проекта (например, в разделе Auth или в настройках API).
- **Сброс пароля БД** — если забыли пароль базы, в **Project Settings → Database** можно задать новый (потребуется перезапуск проекта).

---

## 10. Полезные ссылки

- [Документация Supabase](https://supabase.com/docs)
- [Auth (JavaScript)](https://supabase.com/docs/guides/auth)
- [Row Level Security](https://supabase.com/docs/guides/auth/row-level-security)
- [Схема и типы данных в проекте](01-supabase-schema.md)
